<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태그 기반 매칭</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#a855f7',
                        secondary: '#c084fc'
                    },
                    borderRadius: {
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
</head>
<body class="bg-white">

<!-- 헤더 -->
<header class="w-full bg-white py-3 px-6 flex items-center justify-between border-b border-gray-100">
    <div class="flex items-center space-x-4">
        <a href="/" class="font-['Pacifico'] text-primary text-xl">PoP</a>
        <a href="/about" class="text-gray-600 text-sm flex items-center"><i class="ri-information-line mr-1"></i> 소개</a>
        <a href="/dashboard" class="text-gray-600 text-sm flex items-center"><i class="ri-dashboard-line mr-1"></i> 대시보드</a>
    </div>
    <div class="flex items-center space-x-3">
        <div sec:authorize="isAnonymous()" class="flex items-center space-x-2">
            <a href="/signup" class="text-primary text-sm">회원가입</a>
            <a href="/login" class="bg-primary text-white px-4 py-1.5 text-sm rounded-button">로그인</a>
        </div>
        <div sec:authorize="isAuthenticated()" class="flex items-center space-x-2">
            <span class="text-gray-700 text-sm" th:text="${#authentication.name}">유저이름</span>
            <a href="/profile" class="text-gray-600 text-sm">마이페이지</a>
            <form th:action="@{/logout}" method="post" class="inline">
                <button type="submit" class="bg-secondary text-white px-4 py-1.5 text-sm rounded-button">로그아웃</button>
            </form>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold text-primary mb-6">태그 기반 매칭</h1>

    <form method="post" th:action="@{/match/result}" class="space-y-6">
        <!-- 태그 선택 -->
        <div>
            <label for="tag-input" class="block text-sm font-medium text-gray-700 mb-1">사용할 태그 선택</label>
            <input list="tag-options" id="tag-input" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="태그를 입력하고 Enter를 누르세요">
            <datalist id="tag-options">
                <option th:each="tag : ${skillTags}" th:value="${tag.name}" />
            </datalist>
            <div id="tag-container" class="mt-3 flex flex-wrap gap-2"></div>
            <input type="hidden" name="tags" id="selected-tags">
        </div>

        <!-- 매칭 버튼 -->
        <div class="text-center">
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded-button text-base">매칭 시작</button>
        </div>
    </form>

    <!-- 매칭 결과 출력 -->
    <div th:if="${matchedUsers != null}" class="mt-10">
        <h2 class="text-xl font-semibold text-primary mb-4">매칭된 유저</h2>
        <div class="grid grid-cols-3 gap-6">
            <div th:each="user : ${matchedUsers}" class="border border-gray-200 rounded p-4 shadow-sm">
                <h3 class="text-lg font-bold text-primary" th:text="${user.userId}">유저 이름</h3>
                <p class="text-sm text-gray-600" th:text="${user.email}">기술 스택</p>
            </div>
        </div>
    </div>
</main>

<!-- 푸터 -->
<footer class="w-full bg-gray-50 py-8 border-t border-gray-200">
    <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
        <div>
            <a href="/" class="font-['Pacifico'] text-primary text-xl">PoP</a>
            <p class="text-sm text-gray-600 mt-2">© 2025 PoP. 모든 권리 보유.</p>
        </div>
        <div class="flex space-x-6">
            <a href="#" class="text-gray-600"><i class="ri-instagram-line"></i></a>
            <a href="#" class="text-gray-600"><i class="ri-twitter-x-line"></i></a>
            <a href="#" class="text-gray-600"><i class="ri-linkedin-line"></i></a>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    const validTags = /*[[${skillTagNames}]]*/ [];
    const initialTags = /*[[${tags}]]*/ [];
    const tagInput = document.getElementById('tag-input');
    const tagContainer = document.getElementById('tag-container');
    const hiddenInput = document.getElementById('selected-tags');

    // badge 생성 함수
    function createTagBadge(tag) {
        const span = document.createElement('span');
        span.className = 'bg-purple-100 text-primary px-3 py-1 rounded-full text-sm flex items-center gap-1';
        span.setAttribute('data-tag', tag);
        span.innerHTML = tag + ' <button type="button" class="text-red-500 ml-1">×</button>';

        tagSet.add(tag);
        span.querySelector('button').addEventListener('click', () => {
            tagSet.delete(tag);
            tagContainer.removeChild(span);
            updateHiddenInput();
        });
        tagContainer.appendChild(span);
        updateHiddenInput();
    }

    // 초기 태그 로드
    const tagSet = new Set(initialTags || []);
    tagSet.forEach(tag => createTagBadge(tag));

    function updateHiddenInput() {
        hiddenInput.value = Array.from(tagSet).join(',');
    }

    // 키 입력 이벤트
    tagInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const tag = tagInput.value.trim();
            if (!tag || tagSet.has(tag)) return;
            if (!validTags.includes(tag)) {
                alert('유효하지 않은 태그입니다.');
                return;
            }
            tagSet.add(tag);
            createTagBadge(tag);
            updateHiddenInput();
            tagInput.value = '';
        }
    });

    // 초기 hidden 업데이트
    updateHiddenInput();
    /*]]>*/
</script>
</body>
</html>
